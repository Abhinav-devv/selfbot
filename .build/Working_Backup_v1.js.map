{
  "version": 3,
  "sources": ["../Working_Backup_v1.ts"],
  "sourcesContent": ["const fs = require('fs');\nconst path = require('path');\nconst cron = require('node-cron');\nconst {\n  InworldClient,\n  InworldPacket,\n  ServiceError,\n  SessionToken,\n  status,\n} = require('@inworld/nodejs-sdk');\nconst {\n  Client,\n  DMChannel,\n  GatewayIntentBits,\n  Message,\n  Partials,\n  TextChannel,\n} = require('discord.js');\n\nconst discordClient = new Client({\n  intents: [\n    GatewayIntentBits.Guilds,\n    GatewayIntentBits.GuildMessages,\n    GatewayIntentBits.MessageContent,\n    GatewayIntentBits.DirectMessages,\n    GatewayIntentBits.DirectMessageTyping,\n    GatewayIntentBits.DirectMessageReactions,\n  ],\n  partials: [Partials.Channel],\n});\n\n\nconst sessionsFile = 'sessions.json';\nconst sessions = JSON.parse(fs.readFileSync(sessionsFile, 'utf8'));\n\nconst sessionsFilePath = path.join(__dirname, 'session.json');\n\nconst readSessionsFile = () => {\n  if (!fs.existsSync(sessionsFilePath)) {\n    const emptySessions = {};\n    fs.writeFileSync(sessionsFilePath, JSON.stringify(emptySessions));\n  }\n  return JSON.parse(fs.readFileSync(sessionsFilePath, 'utf8'));\n};\n\nconst resetSessionsFile = () => {\n  if (fs.existsSync(sessionsFilePath)) {\n    try {\n      fs.unlinkSync(sessionsFilePath);\n    } catch (error) {\n      console.error(`Error deleting session.json: ${error.message}`);\n    }\n  }\n\n  const emptySessions = {};\n  fs.writeFileSync(sessionsFilePath, JSON.stringify(emptySessions));\n  console.log('Reset session.json file');\n};\n\n\nconst run = async function () {\n  discordClient.on('ready', () => {\n    console.log(\"I'm ready!\");\n    resetSessionsFile()\n    cron.schedule('*/15 * * * *', resetSessionsFile);\n  });\n\n  discordClient.on('messageCreate', async (message) => {\n    if (message.author.bot) return;\n\n    const hasMentionsOnly = /^<[@|#|@&].*?>$/g.test(message.content.replace(/\\s+/g, ''));    \n\n    if (message.channel instanceof DMChannel) {\n      sendMessage(message, true);\n    } else if (discordClient.user && message.mentions.has(discordClient.user)) {\n     if(hasMentionsOnly) message.content = \"*user says nothing*\";\n      sendMessage(message);\n    }\n  });\n\n  discordClient.login(process.env.DISCORD_BOT_TOKEN);\n};\n\nif (!process.env.INWORLD_KEY) {\n  throw new Error('INWORLD_KEY env variable is required');\n}\nconsole.log(`INWORLD_KEY: ${process.env.INWORLD_KEY}`);\n\nif (!process.env.INWORLD_SECRET) {\n  throw new Error('INWORLD_SECRET env variable is required');\n}\nconsole.log(`INWORLD_SECRET: ${process.env.INWORLD_SECRET}`);\n\nif (!process.env.INWORLD_SCENE) {\n  throw new Error('INWORLD_SCENE env variable is required');\n}\nconsole.log(`INWORLD_SCENE: ${process.env.INWORLD_SCENE}`);\n\nif (!process.env.DISCORD_BOT_TOKEN) {\n  throw new Error('DISCORD_BOT_TOKEN env variable is required');\n}\nconsole.log(`DISCORD_BOT_TOKEN: ${process.env.DISCORD_BOT_TOKEN}`);\n\nrun();\n\nconst sendMessage = async (message, direct) => {\n  const content = message.content.replace(`<@${discordClient.user.id}>`, '');\n\n  const client = await createInworldClient({ direct, message });\n\n  client.sendText(content);\n};\n\nconst getKey = (message) => `${message.channel.id}_${message.author.id}`;\n\nconst generateSessionToken = (key) => {\n  return async () => {\n    console.log('Generating session token...');\n\n    const client = new InworldClient().setApiKey({\n      key: process.env.INWORLD_KEY,\n      secret: process.env.INWORLD_SECRET,\n    });\n\n    console.log(`API key: ${process.env.INWORLD_KEY}`);\n    console.log(`API secret: ${process.env.INWORLD_SECRET}`);\n\n    const token = await client.generateSessionToken();\n\n    console.log(`Generated session token: ${token.toString()}`);\n\n    const sessionId = sessions[key];\n    const actualToken = new SessionToken({\n      expirationTime: token.getExpirationTime(),\n      token: token.getToken(),\n      type: token.getType(),\n      sessionId: sessionId || token.getSessionId(),\n    });\n\n    if (!sessionId) {\n      sessions[key] = actualToken.getSessionId();\n      fs.writeFileSync(sessionsFile, JSON.stringify(sessions));\n    }\n\n    return actualToken;\n  };\n};\n\nconst createInworldClient = async (props) => {\n  const { message, direct } = props;\n\n  const key = getKey(message);\n  const client = new InworldClient()\n    .setGenerateSessionToken(generateSessionToken(key))\n    .setConfiguration({\n      capabilities: { audio: false },\n      ...(direct ? {} : { connection: { disconnectTimeout: 5 * 1000 } }),\n    })\n    .setScene(process.env.INWORLD_SCENE)\n    .setOnError(handleError(message))\n    .setOnMessage((packet) => {\n      if (!direct && packet.isInteractionEnd()) {\n        client.close();\n        return;\n      }\n\n      if (packet.isText() && packet.text.final) {\n        message.channel.send(packet.text.text);\n      }\n    })\n    .build();\n\n  return client;\n};\n\nconst handleError = (message, direct) => {\n  return (err) => {\n    switch (err.code) {\n      case status.ABORTED:\n      case status.CANCELLED:\n        break;\n      case status.FAILED_PRECONDITION:\n        sendMessage(message, direct);\n        break;\n      default:\n        console.error(`Error: ${err.message}`);\n        break;\n    }\n  };\n};\n\nconst done = () => {\n  discordClient.destroy();\n};\n\nprocess.on('SIGINT', done);\nprocess.on('SIGTERM', done);\nprocess.on('SIGUSR2', done);\nprocess.on('unhandledRejection', (err) => {\n  console.error(err.message);\n  done();\n  process.exit(1);\n});"],
  "mappings": ";AAAA,MAAM,KAAK,QAAQ,IAAI;AACvB,MAAM,OAAO,QAAQ,MAAM;AAC3B,MAAM,OAAO,QAAQ,WAAW;AAChC,MAAM;AAAA,EACJ;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,IAAI,QAAQ,qBAAqB;AACjC,MAAM;AAAA,EACJ;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,IAAI,QAAQ,YAAY;AAExB,MAAM,gBAAgB,IAAI,OAAO;AAAA,EAC/B,SAAS;AAAA,IACP,kBAAkB;AAAA,IAClB,kBAAkB;AAAA,IAClB,kBAAkB;AAAA,IAClB,kBAAkB;AAAA,IAClB,kBAAkB;AAAA,IAClB,kBAAkB;AAAA,EACpB;AAAA,EACA,UAAU,CAAC,SAAS,OAAO;AAC7B,CAAC;AAGD,MAAM,eAAe;AACrB,MAAM,WAAW,KAAK,MAAM,GAAG,aAAa,cAAc,MAAM,CAAC;AAEjE,MAAM,mBAAmB,KAAK,KAAK,WAAW,cAAc;AAE5D,MAAM,mBAAmB,MAAM;AAC7B,MAAI,CAAC,GAAG,WAAW,gBAAgB,GAAG;AACpC,UAAM,gBAAgB,CAAC;AACvB,OAAG,cAAc,kBAAkB,KAAK,UAAU,aAAa,CAAC;AAAA,EAClE;AACA,SAAO,KAAK,MAAM,GAAG,aAAa,kBAAkB,MAAM,CAAC;AAC7D;AAEA,MAAM,oBAAoB,MAAM;AAC9B,MAAI,GAAG,WAAW,gBAAgB,GAAG;AACnC,QAAI;AACF,SAAG,WAAW,gBAAgB;AAAA,IAChC,SAAS,OAAP;AACA,cAAQ,MAAM,gCAAgC,MAAM,SAAS;AAAA,IAC/D;AAAA,EACF;AAEA,QAAM,gBAAgB,CAAC;AACvB,KAAG,cAAc,kBAAkB,KAAK,UAAU,aAAa,CAAC;AAChE,UAAQ,IAAI,yBAAyB;AACvC;AAGA,MAAM,MAAM,iBAAkB;AAC5B,gBAAc,GAAG,SAAS,MAAM;AAC9B,YAAQ,IAAI,YAAY;AACxB,sBAAkB;AAClB,SAAK,SAAS,gBAAgB,iBAAiB;AAAA,EACjD,CAAC;AAED,gBAAc,GAAG,iBAAiB,OAAO,YAAY;AACnD,QAAI,QAAQ,OAAO;AAAK;AAExB,UAAM,kBAAkB,mBAAmB,KAAK,QAAQ,QAAQ,QAAQ,QAAQ,EAAE,CAAC;AAEnF,QAAI,QAAQ,mBAAmB,WAAW;AACxC,kBAAY,SAAS,IAAI;AAAA,IAC3B,WAAW,cAAc,QAAQ,QAAQ,SAAS,IAAI,cAAc,IAAI,GAAG;AAC1E,UAAG;AAAiB,gBAAQ,UAAU;AACrC,kBAAY,OAAO;AAAA,IACrB;AAAA,EACF,CAAC;AAED,gBAAc,MAAM,QAAQ,IAAI,iBAAiB;AACnD;AAEA,IAAI,CAAC,QAAQ,IAAI,aAAa;AAC5B,QAAM,IAAI,MAAM,sCAAsC;AACxD;AACA,QAAQ,IAAI,gBAAgB,QAAQ,IAAI,aAAa;AAErD,IAAI,CAAC,QAAQ,IAAI,gBAAgB;AAC/B,QAAM,IAAI,MAAM,yCAAyC;AAC3D;AACA,QAAQ,IAAI,mBAAmB,QAAQ,IAAI,gBAAgB;AAE3D,IAAI,CAAC,QAAQ,IAAI,eAAe;AAC9B,QAAM,IAAI,MAAM,wCAAwC;AAC1D;AACA,QAAQ,IAAI,kBAAkB,QAAQ,IAAI,eAAe;AAEzD,IAAI,CAAC,QAAQ,IAAI,mBAAmB;AAClC,QAAM,IAAI,MAAM,4CAA4C;AAC9D;AACA,QAAQ,IAAI,sBAAsB,QAAQ,IAAI,mBAAmB;AAEjE,IAAI;AAEJ,MAAM,cAAc,OAAO,SAAS,WAAW;AAC7C,QAAM,UAAU,QAAQ,QAAQ,QAAQ,KAAK,cAAc,KAAK,OAAO,EAAE;AAEzE,QAAM,SAAS,MAAM,oBAAoB,EAAE,QAAQ,QAAQ,CAAC;AAE5D,SAAO,SAAS,OAAO;AACzB;AAEA,MAAM,SAAS,CAAC,YAAY,GAAG,QAAQ,QAAQ,MAAM,QAAQ,OAAO;AAEpE,MAAM,uBAAuB,CAAC,QAAQ;AACpC,SAAO,YAAY;AACjB,YAAQ,IAAI,6BAA6B;AAEzC,UAAM,SAAS,IAAI,cAAc,EAAE,UAAU;AAAA,MAC3C,KAAK,QAAQ,IAAI;AAAA,MACjB,QAAQ,QAAQ,IAAI;AAAA,IACtB,CAAC;AAED,YAAQ,IAAI,YAAY,QAAQ,IAAI,aAAa;AACjD,YAAQ,IAAI,eAAe,QAAQ,IAAI,gBAAgB;AAEvD,UAAM,QAAQ,MAAM,OAAO,qBAAqB;AAEhD,YAAQ,IAAI,4BAA4B,MAAM,SAAS,GAAG;AAE1D,UAAM,YAAY,SAAS;AAC3B,UAAM,cAAc,IAAI,aAAa;AAAA,MACnC,gBAAgB,MAAM,kBAAkB;AAAA,MACxC,OAAO,MAAM,SAAS;AAAA,MACtB,MAAM,MAAM,QAAQ;AAAA,MACpB,WAAW,aAAa,MAAM,aAAa;AAAA,IAC7C,CAAC;AAED,QAAI,CAAC,WAAW;AACd,eAAS,OAAO,YAAY,aAAa;AACzC,SAAG,cAAc,cAAc,KAAK,UAAU,QAAQ,CAAC;AAAA,IACzD;AAEA,WAAO;AAAA,EACT;AACF;AAEA,MAAM,sBAAsB,OAAO,UAAU;AAC3C,QAAM,EAAE,SAAS,OAAO,IAAI;AAE5B,QAAM,MAAM,OAAO,OAAO;AAC1B,QAAM,SAAS,IAAI,cAAc,EAC9B,wBAAwB,qBAAqB,GAAG,CAAC,EACjD,iBAAiB;AAAA,IAChB,cAAc,EAAE,OAAO,MAAM;AAAA,IAC7B,GAAI,SAAS,CAAC,IAAI,EAAE,YAAY,EAAE,mBAAmB,IAAI,IAAK,EAAE;AAAA,EAClE,CAAC,EACA,SAAS,QAAQ,IAAI,aAAa,EAClC,WAAW,YAAY,OAAO,CAAC,EAC/B,aAAa,CAAC,WAAW;AACxB,QAAI,CAAC,UAAU,OAAO,iBAAiB,GAAG;AACxC,aAAO,MAAM;AACb;AAAA,IACF;AAEA,QAAI,OAAO,OAAO,KAAK,OAAO,KAAK,OAAO;AACxC,cAAQ,QAAQ,KAAK,OAAO,KAAK,IAAI;AAAA,IACvC;AAAA,EACF,CAAC,EACA,MAAM;AAET,SAAO;AACT;AAEA,MAAM,cAAc,CAAC,SAAS,WAAW;AACvC,SAAO,CAAC,QAAQ;AACd,YAAQ,IAAI,MAAM;AAAA,MAChB,KAAK,OAAO;AAAA,MACZ,KAAK,OAAO;AACV;AAAA,MACF,KAAK,OAAO;AACV,oBAAY,SAAS,MAAM;AAC3B;AAAA,MACF;AACE,gBAAQ,MAAM,UAAU,IAAI,SAAS;AACrC;AAAA,IACJ;AAAA,EACF;AACF;AAEA,MAAM,OAAO,MAAM;AACjB,gBAAc,QAAQ;AACxB;AAEA,QAAQ,GAAG,UAAU,IAAI;AACzB,QAAQ,GAAG,WAAW,IAAI;AAC1B,QAAQ,GAAG,WAAW,IAAI;AAC1B,QAAQ,GAAG,sBAAsB,CAAC,QAAQ;AACxC,UAAQ,MAAM,IAAI,OAAO;AACzB,OAAK;AACL,UAAQ,KAAK,CAAC;AAChB,CAAC;",
  "names": []
}
